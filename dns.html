<!DOCTYPE html>
<html lang="">
  <head>
    <title>Mimic CNAME with local DNS server</title>
    <link rel="stylesheet" href="dns.css">
  </head>
  <body>
    <header>
      <a href="/index.html">home</a>
    </header>
    <h1>Testing CNAMEs with a local DNS server</h1>
    <h2>Motivation</h2>
    <p>
      You are the owner of www.ithaityson.com. Digging your website shows that it is currently configured like this.
    </p>
<pre><code>;; ANSWER SECTION:
www.ithaityson.com.	3481	IN	CNAME	ithaityson.com.
ithaityson.com.		458	IN	A	198.71.233.184
</code></pre>

    <p>
      No one eats at your restaurant so you've decided to franchise as a Captain Ds location. Digging locations.captainds.com we see
    </p>

<pre><code>;; ANSWER SECTION:
locations.captainds.com. 59	IN	CNAME	captainds.momentfeed.com.
captainds.momentfeed.com. 59	IN	CNAME	prod-norcal-llp-alb-986012353.us-west-1.elb.amazonaws.com.
prod-norcal-llp-alb-986012353.us-west-1.elb.amazonaws.com. 59 IN A 54.193.72.95
prod-norcal-llp-alb-986012353.us-west-1.elb.amazonaws.com. 59 IN A 52.8.234.119
</code></pre>

    <p>
      Captain Ds corporate has built a shiny new website for you and in order to start using it they've asked you to update your DNS
      to also CNAME to captainds.momentfeed.com.
      It's easy enough to update your DNS record, but how do you verify that everything will work when you do?
      This page summarizes how to mimic the effects of an arbitrary DNS CNAME locally.
    </p>

    <h2>Approach</h2>
    <p>
      The first thing you might consider is to modify the /etc/hosts file. Unfortunately this can only alias domains to explicit IPs so it's not possible
      to totally replicate the change.
    </p>
    <p>
      To really mimic the DNS update we need to set up a DNS server locally that can return the records that we want. There are a couple of steps to doing this.
      <ol>
        <li>
          <a href="#1">Set up a recursive DNS server</a>
        </li>
        <li>
          <a href="#2">Set up an authoritative DNS server</a>
        </li>
        <li>
          <a href="#3">Tie them together and test end to end</a>
        </li>
      </ol>

    </p>

    <h3>
      Set up a recursive DNS server
    </h3>
    <p>
      A recursive DNS server is what typical hosts talk to in order to leanrn the IP of a domain. It's essentially a cache that knows who to ask for more information
      in the case of a cache miss.
    </p>

    Install Unbound
    	brew install unbound

    Setting up unbound.

    1. Config is located in /usr/local/etc/unbound/unbound.conf

    you can look through the defaults if you want but here's what we want

    <pre>
      <code>
server:
  username: bhaines
  logfile: "/etc/unbound/unbound.log"  #uncomment to use logfile.
  pidfile: "/etc/unbound/unbound.pid"
  # listen on all interfaces, answer queries from the local subnet.
  interface: 0.0.0.0
  interface: ::0

forward-zone:
  name: "."
  forward-addr: 8.8.8.8@53
      </code>
    </pre>

    now you can run `sudo unbound -d` (the d prevents it from running in the background so you can see logs and easily kill it with ctrl-c)

    at this point you have a working DNS server running on localhost. you should be able to run
    `dig www.google.com @127.0.0.1` and get a result.

    to actually use it for you computer you can go into system preferences > network > advanced > dns and add 127.0.0.1 as a DNS Server in the left window.
    hit ok and then make sure to hit "Apply" as well. Now your computer is using your local DNS!

    If you do some googling you might think that you can use local-data https://nlnetlabs.nl/documentation/unbound/unbound.conf/ to hardcode a cname within
    your unbound conf but you would be wrong. if you read that thing you'll not it says you will need to set up a stub zone. Each stub zone has an
    associated name server which must be authoritative (which unbound is not). basically you need to run something else to be the authoritative name serve
    for the domain you want to modify.

    In order to set up a CNAME you have to use an "Authoritative DNS Server" we'll use NSD.
    Install it with
    `brew install nsd`

    There's a default config in /usr/local/etc/nsd/nsd.conf.sample you can look at. we want to create a config at
    /usr/local/etc/nsd/nsd.conf

    Here's what we want.

    <pre>
      <code>
server:
  zonesdir: "/usr/local/etc/nsd"
  username: bhaines
  port: 53530

remote-control:
  control-enable: yes

key:
  name: "sec_key"
  algorithm: hmac-md5
  secret: "6KM6qiKfwfEpamEq72HQdA=="

zone:
  name: pfchangs.com
  zonefile: pfchangs.com.forward
      </code>
    </pre>

    we also need to set up the zone file referenced in the config. it should go in /usr/local/etc/nsd and looks like this

    <pre>
      <code>
$ORIGIN pfchangs.com.    ; default zone domain
$TTL 86400           ; default time to live

pfchangs.com. IN SOA ns1.pfchangs.com. hostmaster.pfchangs.com. (
          2011010203  ; serial number
          28800       ; Refresh
          7200        ; Retry
          864000      ; Expire
          86400       ; Min TTL
          )

ns1.pfchangs.com.   3600    IN  A   127.0.0.1
locations.pfchangs.com. 3600    IN  CNAME   www.nattathai.com.
      </code>
    </pre>

    we want to be able to use the remote control so first run  `nsd-control-setup`

    now run it with  `sudo nsd -d`

    now you have an authoritative name server running locally on port 535350.

    at this point you should be able to dig directly at 535350 to see the effect of your cname

    The next part is letting unbound know about nds.

    We'll add a couple things to the config.

    under the server: section add
    <pre>
      <code>
local-zone: pfchangs.com nodefault
domain-insecure: "pfchangs.com"
      </code>
    </pre>

    then at the top level add

    <pre>
      <code>
do-not-query-localhost: no

stub-zone:
  name: "pfchangs.com"
  stub-addr: 127.0.0.1@53530
  stub-no-cache: yes
      </code>
    </pre>

    restart unbound(can ctrl-c and run it again with same command from before)
  </body>
</html>
